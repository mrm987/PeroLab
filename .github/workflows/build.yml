name: Build and Release

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install pyinstaller pywebview fastapi uvicorn httpx pillow numpy pydantic aiofiles

      - name: Build with PyInstaller
        run: |
          python -c "
          import subprocess
          import sys

          options = [
              'app.py',
              '--name=PeroPix',
              '--onedir',
              '--windowed',
              '--noconfirm',
              '--add-data=index.html;.',
              # backend.py를 모듈로 포함
              '--hidden-import=backend',
              # uvicorn 관련
              '--hidden-import=uvicorn',
              '--hidden-import=uvicorn.logging',
              '--hidden-import=uvicorn.loops',
              '--hidden-import=uvicorn.loops.auto',
              '--hidden-import=uvicorn.protocols',
              '--hidden-import=uvicorn.protocols.http',
              '--hidden-import=uvicorn.protocols.http.auto',
              '--hidden-import=uvicorn.protocols.websockets',
              '--hidden-import=uvicorn.protocols.websockets.auto',
              '--hidden-import=uvicorn.lifespan',
              '--hidden-import=uvicorn.lifespan.on',
              # FastAPI 관련
              '--hidden-import=fastapi',
              '--hidden-import=starlette',
              '--hidden-import=starlette.responses',
              '--hidden-import=starlette.routing',
              '--hidden-import=starlette.middleware',
              '--hidden-import=starlette.middleware.cors',
              # pywebview
              '--hidden-import=webview',
              '--hidden-import=clr',
              # 기타
              '--hidden-import=PIL',
              '--hidden-import=PIL.Image',
              '--hidden-import=numpy',
              '--hidden-import=httpx',
              '--hidden-import=pydantic',
              '--hidden-import=aiofiles',
              '--collect-all=uvicorn',
              '--collect-all=fastapi',
              '--collect-all=starlette',
          ]

          cmd = [sys.executable, '-m', 'PyInstaller'] + options
          subprocess.run(cmd, check=True)
          "

      - name: Prepare Release Package
        shell: pwsh
        run: |
          # index.html 복사 (add-data가 제대로 안 될 경우 대비)
          Copy-Item "index.html" -Destination "dist/PeroPix/_internal/" -ErrorAction SilentlyContinue
          Copy-Item "index.html" -Destination "dist/PeroPix/" -ErrorAction SilentlyContinue

          # prompts 폴더 복사
          Copy-Item -Recurse "prompts" -Destination "dist/PeroPix/"

          # 빈 폴더 생성
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/models/checkpoints"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/models/loras"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/models/upscale_models"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/outputs"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/presets"

          # README 복사
          Copy-Item "README.md" -Destination "dist/PeroPix/" -ErrorAction SilentlyContinue

          # zip 압축
          Compress-Archive -Path "dist/PeroPix/*" -DestinationPath "PeroPix-Windows.zip"

      - name: Upload Release Asset
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: PeroPix-Windows.zip
          tag_name: ${{ github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Build Artifact
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: PeroPix-Windows
          path: PeroPix-Windows.zip
          retention-days: 7
